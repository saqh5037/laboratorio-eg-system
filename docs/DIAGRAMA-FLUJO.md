# Diagrama de Flujo - Sistema de SincronizaciÃ³n AutomÃ¡tica

## Vista General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚                     LABORATORIO EG - ARQUITECTURA                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


          USUARIO                    BASE DE DATOS                SERVICIOS
             â”‚                            â”‚                           â”‚
             â”‚                            â”‚                           â”‚
             â–¼                            â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚        â”‚                  â”‚       â”‚                  â”‚
    â”‚  LABSIS (LIS)   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  PostgreSQL      â”‚â”€â”€â”€â”€â”€â”€â”€â”‚  Backend API     â”‚
    â”‚                 â”‚        â”‚  labsisEG        â”‚   â”‚   â”‚  (port 3001)     â”‚
    â”‚  â€¢ Modificar    â”‚        â”‚                  â”‚   â”‚   â”‚                  â”‚
    â”‚    precios      â”‚        â”‚  Tablas:         â”‚   â”‚   â”‚  â€¢ REST API      â”‚
    â”‚  â€¢ Lista ID 27  â”‚        â”‚  â”œâ”€ prueba       â”‚   â”‚   â”‚  â€¢ Cache         â”‚
    â”‚                 â”‚        â”‚  â”œâ”€ grupo_prueba â”‚   â”‚   â”‚  â€¢ Listener      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”œâ”€ lista_       â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚  â”‚  precios_has_ â”‚   â”‚            â”‚
                               â”‚  â”‚  prueba       â”‚   â”‚            â”‚
                               â”‚  â””â”€ lista_       â”‚   â”‚            â–¼
                               â”‚     precios_has_ â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚     gprueba      â”‚   â””â”€â”€â–¶â”‚  Sync Service    â”‚
                               â”‚                  â”‚       â”‚  (port 3002)     â”‚
                               â”‚  TRIGGERS:       â”‚       â”‚                  â”‚
                               â”‚  â”œâ”€ INSERT       â”‚       â”‚  â€¢ Listener      â”‚
                               â”‚  â”œâ”€ UPDATE       â”‚â—€â”€â”€â”€â”€â”€â”€â”‚  â€¢ JSON Gen      â”‚
                               â”‚  â””â”€ DELETE       â”‚       â”‚  â€¢ Auto-copy     â”‚
                               â”‚         â”‚        â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚         â”‚        â”‚                â”‚
                               â”‚         â–¼        â”‚                â”‚
                               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚
                               â”‚  â”‚  NOTIFY    â”‚ â”‚                â”‚
                               â”‚  â”‚  precio_   â”‚ â”‚                â”‚
                               â”‚  â”‚  cambio    â”‚ â”‚                â”‚
                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                                                                   â”‚
                                                                   â–¼
                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                       â”‚   precios.json       â”‚
                                                       â”‚   (auto-generado)    â”‚
                                                       â”‚   ~1.2MB             â”‚
                                                       â”‚   513 estudios       â”‚
                                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                                                                   â”‚
                                                                   â–¼
                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                       â”‚  Frontend (Vite)     â”‚
                                                       â”‚  http://localhost:   â”‚
                                                       â”‚  5173/estudios       â”‚
                                                       â”‚                      â”‚
                                                       â”‚  â€¢ Lee JSON          â”‚
                                                       â”‚  â€¢ PWA               â”‚
                                                       â”‚  â€¢ Cache Browser     â”‚
                                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                                                                   â–¼
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚ USUARIO â”‚
                                                              â”‚ Ve      â”‚
                                                              â”‚ precios â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo Detallado de SincronizaciÃ³n

```
PASO 1: CAMBIO DE PRECIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USUARIO   â”‚  Modifica precio en Labsis
â”‚  (Labsis)  â”‚  Lista de precios ID 27
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  SQL: UPDATE lista_precios_has_gprueba
      â”‚       SET precio = 10.00
      â”‚       WHERE gprueba_id = 1 AND lista_precios_id = 27
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL Database (labsisEG)         â”‚
â”‚                                          â”‚
â”‚   tabla: lista_precios_has_gprueba       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ gprueba_id â”‚ precio â”‚ UPDATE   â”‚    â”‚
â”‚   â”‚     1      â”‚ 10.00  â”‚  âœ…      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚   â±ï¸  Tiempo: ~1ms                       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  TRIGGER: precio_cambio_notify
      â”‚  dispara automÃ¡ticamente
      â”‚
      â–¼


PASO 2: NOTIFICACIÃ“N POSTGRESQL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL NOTIFY                      â”‚
â”‚                                          â”‚
â”‚   NOTIFY precio_cambio, '{               â”‚
â”‚     "tabla": "lista_precios_has_gprueba",â”‚
â”‚     "operacion": "UPDATE",               â”‚
â”‚     "timestamp": "2025-10-22...",        â”‚
â”‚     "registro_id": 1536,                 â”‚
â”‚     "lista_precios_id": 27               â”‚
â”‚   }'                                     â”‚
â”‚                                          â”‚
â”‚   â±ï¸  Tiempo: ~1ms                       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Broadcast a todos los listeners
      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚                â”‚
      â–¼                 â–¼                â–¼


PASO 3: LISTENERS RECIBEN NOTIFICACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend API       â”‚   â”‚   Sync Service       â”‚
â”‚   (port 3001)       â”‚   â”‚   (port 3002)        â”‚
â”‚                     â”‚   â”‚                      â”‚
â”‚  ğŸ”” NotificaciÃ³n    â”‚   â”‚  ğŸ”” NotificaciÃ³n     â”‚
â”‚     recibida        â”‚   â”‚     recibida         â”‚
â”‚                     â”‚   â”‚                      â”‚
â”‚  Payload:           â”‚   â”‚  Payload:            â”‚
â”‚  â€¢ tabla: ...       â”‚   â”‚  â€¢ tabla: ...        â”‚
â”‚  â€¢ operacion: ...   â”‚   â”‚  â€¢ operacion: ...    â”‚
â”‚                     â”‚   â”‚                      â”‚
â”‚  â±ï¸  InstantÃ¡neo     â”‚   â”‚  â±ï¸  InstantÃ¡neo      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                          â”‚
      â”‚                          â”‚
      â–¼                          â–¼


PASO 4A: BACKEND INVALIDA CACHE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend Cache Manager             â”‚
â”‚                                     â”‚
â”‚   ğŸ—‘ï¸  Invalidando cachÃ©:            â”‚
â”‚   â€¢ Grupos (grupos:*)               â”‚
â”‚   â€¢ BÃºsquedas (search:*)            â”‚
â”‚   â€¢ Unificado (unified:*)           â”‚
â”‚                                     â”‚
â”‚   NodeCache cleared: 3 keys         â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: ~1ms                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Siguiente request traerÃ¡
      â”‚  datos frescos de PostgreSQL
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âœ… Cache listo para servir         â”‚
â”‚      datos actualizados             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PASO 4B: SYNC SERVICE GENERA JSON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sync Service                      â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Debounce: 2 segundos           â”‚
â”‚   (agrupa mÃºltiples cambios)        â”‚
â”‚                                     â”‚
â”‚   Timer: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%    â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: 2000ms                 â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Debounce completado
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“Š Consultando PostgreSQL          â”‚
â”‚                                     â”‚
â”‚   Query 1: SELECT * FROM prueba     â”‚
â”‚            JOIN lista_precios_      â”‚
â”‚            has_prueba...            â”‚
â”‚            WHERE lista_precios_id=27â”‚
â”‚            â†’ 349 pruebas            â”‚
â”‚                                     â”‚
â”‚   Query 2: SELECT * FROM grupo_     â”‚
â”‚            prueba JOIN lista_       â”‚
â”‚            precios_has_gprueba...   â”‚
â”‚            WHERE lista_precios_id=27â”‚
â”‚            â†’ 164 grupos             â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: ~50-70ms               â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Total: 513 estudios obtenidos
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ”„ Transformando a JSON            â”‚
â”‚                                     â”‚
â”‚   Estructura:                       â”‚
â”‚   {                                 â”‚
â”‚     "metadata": {...},              â”‚
â”‚     "estudios": [                   â”‚
â”‚       {                             â”‚
â”‚         "id": 1,                    â”‚
â”‚         "nombre": "HematologÃ­a...", â”‚
â”‚         "precio": 10.00,            â”‚
â”‚         "tipo_item": "grupo",       â”‚
â”‚         ...                         â”‚
â”‚       },                            â”‚
â”‚       ...                           â”‚
â”‚     ]                               â”‚
â”‚   }                                 â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: ~10ms                  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  JSON listo: ~1.2MB
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ’¾ Guardando JSON                  â”‚
â”‚                                     â”‚
â”‚   Destino 1:                        â”‚
â”‚   /sync-service/output/precios.json â”‚
â”‚   âœ… Guardado                        â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: ~5ms                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Auto-copy activado
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“‹ Copiando a proyecto web         â”‚
â”‚                                     â”‚
â”‚   Destino 2:                        â”‚
â”‚   /laboratorio-eg/public/data/      â”‚
â”‚   precios.json                      â”‚
â”‚   âœ… Copiado                         â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo: ~2ms                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  âœ… SincronizaciÃ³n completada
      â”‚
      â–¼


PASO 5: JSON DISPONIBLE PARA FRONTEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Archivo actualizado:              â”‚
â”‚                                     â”‚
â”‚   ğŸ“„ /laboratorio-eg/public/data/    â”‚
â”‚      precios.json                   â”‚
â”‚                                     â”‚
â”‚   TamaÃ±o: 1.2 MB                    â”‚
â”‚   Estudios: 513                     â”‚
â”‚   Timestamp: 2025-10-22 11:54:40    â”‚
â”‚                                     â”‚
â”‚   Disponible en:                    â”‚
â”‚   http://localhost:5173/data/       â”‚
â”‚   precios.json                      â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo total desde cambio:     â”‚
â”‚      ~2.1 segundos                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Usuario refresca navegador
      â”‚  (Cmd+Shift+R)
      â”‚
      â–¼


PASO 6: FRONTEND CARGA NUEVO JSON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend (React + Vite)           â”‚
â”‚   http://localhost:5173/estudios    â”‚
â”‚                                     â”‚
â”‚   Hook: useLabData()                â”‚
â”‚   â”œâ”€ fetch('/data/precios.json')   â”‚
â”‚   â”œâ”€ Parse JSON                     â”‚
â”‚   â”œâ”€ Cache en localStorage          â”‚
â”‚   â””â”€ Renderizar estudios            â”‚
â”‚                                     â”‚
â”‚   â±ï¸  Tiempo de carga: ~100-200ms    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  UI actualizada
      â”‚
      â–¼


PASO 7: USUARIO VE PRECIO ACTUALIZADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ–¥ï¸  Pantalla del Usuario           â”‚
â”‚                                     â”‚
â”‚   Estudios > BÃºsqueda:              â”‚
â”‚   "HematologÃ­a Completa"            â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ HematologÃ­a Completa          â”‚ â”‚
â”‚   â”‚ CÃ³digo: 1001                  â”‚ â”‚
â”‚   â”‚ Precio: $10.00 âœ…             â”‚ â”‚
â”‚   â”‚                               â”‚ â”‚
â”‚   â”‚ [Ver Detalles]                â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚   âœ… Precio actualizado correctamenteâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tiempos de PropagaciÃ³n

```
Evento                              Tiempo      Acumulado
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
UPDATE en PostgreSQL                ~1ms        1ms
TRIGGER dispara NOTIFY              ~1ms        2ms
Listeners reciben notificaciÃ³n      ~1ms        3ms
Backend invalida cache              ~1ms        4ms
Sync Service inicia debounce        â€”           â€”
  â¸ï¸  Espera (agrupa cambios)        2000ms      2004ms
Sync consulta PostgreSQL            ~70ms       2074ms
Transforma datos a JSON             ~10ms       2084ms
Guarda JSON local                   ~5ms        2089ms
Copia a proyecto web                ~2ms        2091ms
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
TOTAL: Cambio â†’ JSON disponible     ~2.1 segundos

Usuario refresca navegador          ~200ms      2291ms
Frontend carga y renderiza          ~100ms      2391ms
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
TOTAL: Cambio â†’ Usuario ve precio   ~2.4 segundos
```

---

## Componentes CrÃ­ticos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COMPONENTE: Backend API                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Archivo: server/config/pg-listener.js                          â”‚
â”‚                                                                  â”‚
â”‚  class PostgresListener {                                       â”‚
â”‚    async connect() {                                            â”‚
â”‚      this.client = new Client({...});                           â”‚
â”‚      await this.client.connect();                               â”‚
â”‚      await this.client.query('LISTEN precio_cambio');           â”‚
â”‚                                                                  â”‚
â”‚      this.client.on('notification', (msg) => {                  â”‚
â”‚        this.handleNotification(msg);                            â”‚
â”‚      });                                                         â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚    handleNotification(msg) {                                    â”‚
â”‚      const payload = JSON.parse(msg.payload);                   â”‚
â”‚      this.invalidateCache(payload);                             â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚    invalidateCache(payload) {                                   â”‚
â”‚      if (payload.tabla === 'lista_precios_has_prueba') {        â”‚
â”‚        cacheManager.invalidate('pruebas');                      â”‚
â”‚      }                                                           â”‚
â”‚      if (payload.tabla === 'lista_precios_has_gprueba') {       â”‚
â”‚        cacheManager.invalidate('grupos');                       â”‚
â”‚      }                                                           â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  âœ… Estado: ACTIVO                                               â”‚
â”‚  ğŸ”Œ Puerto: 3001                                                 â”‚
â”‚  ğŸ“¡ Canal: precio_cambio                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMPONENTE: Sync Service                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Archivo: src/services/postgres-listener.js                     â”‚
â”‚                                                                  â”‚
â”‚  class SyncListener {                                           â”‚
â”‚    constructor() {                                              â”‚
â”‚      this.debounceTimer = null;                                 â”‚
â”‚      this.debounceMs = 2000;                                    â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚    async start() {                                              â”‚
â”‚      this.client = new Client({...});                           â”‚
â”‚      await this.client.connect();                               â”‚
â”‚      await this.client.query('LISTEN precio_cambio');           â”‚
â”‚                                                                  â”‚
â”‚      this.client.on('notification', (msg) => {                  â”‚
â”‚        this.handleNotification(msg);                            â”‚
â”‚      });                                                         â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚    handleNotification(msg) {                                    â”‚
â”‚      clearTimeout(this.debounceTimer);                          â”‚
â”‚                                                                  â”‚
â”‚      this.debounceTimer = setTimeout(() => {                    â”‚
â”‚        this.triggerSync();                                      â”‚
â”‚      }, this.debounceMs);                                       â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚    async triggerSync() {                                        â”‚
â”‚      await sync(); // Genera JSON                               â”‚
â”‚      // Auto-copy activado en file-service.js                   â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  âœ… Estado: ACTIVO                                               â”‚
â”‚  ğŸ”Œ Puerto: 3002                                                 â”‚
â”‚  ğŸ“¡ Canal: precio_cambio                                         â”‚
â”‚  â±ï¸  Debounce: 2000ms                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMPONENTE: PostgreSQL Trigger                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Tablas monitoreadas:                                           â”‚
â”‚  â€¢ lista_precios_has_prueba                                     â”‚
â”‚  â€¢ lista_precios_has_gprueba                                    â”‚
â”‚                                                                  â”‚
â”‚  Trigger: precio_cambio_notify                                  â”‚
â”‚                                                                  â”‚
â”‚  CREATE OR REPLACE FUNCTION notify_precio_cambio()              â”‚
â”‚  RETURNS trigger AS $$                                          â”‚
â”‚  BEGIN                                                           â”‚
â”‚    PERFORM pg_notify('precio_cambio',                           â”‚
â”‚      json_build_object(                                         â”‚
â”‚        'tabla', TG_TABLE_NAME,                                  â”‚
â”‚        'operacion', TG_OP,                                      â”‚
â”‚        'timestamp', NOW(),                                      â”‚
â”‚        'registro_id', NEW.id,                                   â”‚
â”‚        'lista_precios_id', NEW.lista_precios_id                 â”‚
â”‚      )::text                                                    â”‚
â”‚    );                                                            â”‚
â”‚    RETURN NEW;                                                  â”‚
â”‚  END;                                                            â”‚
â”‚  $$ LANGUAGE plpgsql;                                           â”‚
â”‚                                                                  â”‚
â”‚  Eventos: INSERT, UPDATE, DELETE                                â”‚
â”‚                                                                  â”‚
â”‚  âœ… Estado: INSTALADO                                            â”‚
â”‚  ğŸ“¡ Canal: precio_cambio                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Ãšltima actualizaciÃ³n:** 22 de Octubre, 2025
