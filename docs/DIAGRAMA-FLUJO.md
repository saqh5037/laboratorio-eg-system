# Diagrama de Flujo - Sistema de Sincronizaciรณn Automรกtica

## Vista General del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                         โ
โ                     LABORATORIO EG - ARQUITECTURA                       โ
โ                                                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


          USUARIO                    BASE DE DATOS                SERVICIOS
             โ                            โ                           โ
             โ                            โ                           โ
             โผ                            โผ                           โผ
    โโโโโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโโ
    โ                 โ        โ                  โ       โ                  โ
    โ  LABSIS (LIS)   โโโโโโโโโถโ  PostgreSQL      โโโโโโโโโ  Backend API     โ
    โ                 โ        โ  labsisEG        โ   โ   โ  (port 3001)     โ
    โ  โข Modificar    โ        โ                  โ   โ   โ                  โ
    โ    precios      โ        โ  Tablas:         โ   โ   โ  โข REST API      โ
    โ  โข Lista ID 27  โ        โ  โโ prueba       โ   โ   โ  โข Cache         โ
    โ                 โ        โ  โโ grupo_prueba โ   โ   โ  โข Listener      โ
    โโโโโโโโโโโโโโโโโโโ        โ  โโ lista_       โ   โ   โโโโโโโโโโโโโโโโโโโโ
                               โ  โ  precios_has_ โ   โ            โ
                               โ  โ  prueba       โ   โ            โ
                               โ  โโ lista_       โ   โ            โผ
                               โ     precios_has_ โ   โ   โโโโโโโโโโโโโโโโโโโโ
                               โ     gprueba      โ   โโโโถโ  Sync Service    โ
                               โ                  โ       โ  (port 3002)     โ
                               โ  TRIGGERS:       โ       โ                  โ
                               โ  โโ INSERT       โ       โ  โข Listener      โ
                               โ  โโ UPDATE       โโโโโโโโโ  โข JSON Gen      โ
                               โ  โโ DELETE       โ       โ  โข Auto-copy     โ
                               โ         โ        โ       โโโโโโโโโโโโโโโโโโโโ
                               โ         โ        โ                โ
                               โ         โผ        โ                โ
                               โ  โโโโโโโโโโโโโโ โ                โ
                               โ  โ  NOTIFY    โ โ                โ
                               โ  โ  precio_   โ โ                โ
                               โ  โ  cambio    โ โ                โ
                               โ  โโโโโโโโโโโโโโ โ                โ
                               โโโโโโโโโโโโโโโโโโโโ                โ
                                                                   โ
                                                                   โผ
                                                       โโโโโโโโโโโโโโโโโโโโโโโโ
                                                       โ   precios.json       โ
                                                       โ   (auto-generado)    โ
                                                       โ   ~1.2MB             โ
                                                       โ   513 estudios       โ
                                                       โโโโโโโโโโโโโโโโโโโโโโโโ
                                                                   โ
                                                                   โ
                                                                   โผ
                                                       โโโโโโโโโโโโโโโโโโโโโโโโ
                                                       โ  Frontend (Vite)     โ
                                                       โ  http://localhost:   โ
                                                       โ  5173/estudios       โ
                                                       โ                      โ
                                                       โ  โข Lee JSON          โ
                                                       โ  โข PWA               โ
                                                       โ  โข Cache Browser     โ
                                                       โโโโโโโโโโโโโโโโโโโโโโโโ
                                                                   โ
                                                                   โผ
                                                              โโโโโโโโโโโ
                                                              โ USUARIO โ
                                                              โ Ve      โ
                                                              โ precios โ
                                                              โโโโโโโโโโโ
```

---

## Flujo Detallado de Sincronizaciรณn

```
PASO 1: CAMBIO DE PRECIO
โโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโ
โ  USUARIO   โ  Modifica precio en Labsis
โ  (Labsis)  โ  Lista de precios ID 27
โโโโโโโฌโโโโโโโ
      โ
      โ  SQL: UPDATE lista_precios_has_gprueba
      โ       SET precio = 10.00
      โ       WHERE gprueba_id = 1 AND lista_precios_id = 27
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   PostgreSQL Database (labsisEG)         โ
โ                                          โ
โ   tabla: lista_precios_has_gprueba       โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ   โ gprueba_id โ precio โ UPDATE   โ    โ
โ   โ     1      โ 10.00  โ  โ      โ    โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                          โ
โ   โฑ๏ธ  Tiempo: ~1ms                       โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  TRIGGER: precio_cambio_notify
      โ  dispara automรกticamente
      โ
      โผ


PASO 2: NOTIFICACIรN POSTGRESQL
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   PostgreSQL NOTIFY                      โ
โ                                          โ
โ   NOTIFY precio_cambio, '{               โ
โ     "tabla": "lista_precios_has_gprueba",โ
โ     "operacion": "UPDATE",               โ
โ     "timestamp": "2025-10-22...",        โ
โ     "registro_id": 1536,                 โ
โ     "lista_precios_id": 27               โ
โ   }'                                     โ
โ                                          โ
โ   โฑ๏ธ  Tiempo: ~1ms                       โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Broadcast a todos los listeners
      โ
      โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
      โ                 โ                โ
      โผ                 โผ                โผ


PASO 3: LISTENERS RECIBEN NOTIFICACIรN
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโ
โ   Backend API       โ   โ   Sync Service       โ
โ   (port 3001)       โ   โ   (port 3002)        โ
โ                     โ   โ                      โ
โ  ๐ Notificaciรณn    โ   โ  ๐ Notificaciรณn     โ
โ     recibida        โ   โ     recibida         โ
โ                     โ   โ                      โ
โ  Payload:           โ   โ  Payload:            โ
โ  โข tabla: ...       โ   โ  โข tabla: ...        โ
โ  โข operacion: ...   โ   โ  โข operacion: ...    โ
โ                     โ   โ                      โ
โ  โฑ๏ธ  Instantรกneo     โ   โ  โฑ๏ธ  Instantรกneo      โ
โโโโโโโฌโโโโโโโโโโโโโโโโ   โโโโโโโโฌโโโโโโโโโโโโโโโโ
      โ                          โ
      โ                          โ
      โผ                          โผ


PASO 4A: BACKEND INVALIDA CACHE
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Backend Cache Manager             โ
โ                                     โ
โ   ๐๏ธ  Invalidando cachรฉ:            โ
โ   โข Grupos (grupos:*)               โ
โ   โข Bรบsquedas (search:*)            โ
โ   โข Unificado (unified:*)           โ
โ                                     โ
โ   NodeCache cleared: 3 keys         โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: ~1ms                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Siguiente request traerรก
      โ  datos frescos de PostgreSQL
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   โ Cache listo para servir         โ
โ      datos actualizados             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


PASO 4B: SYNC SERVICE GENERA JSON
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Sync Service                      โ
โ                                     โ
โ   โฑ๏ธ  Debounce: 2 segundos           โ
โ   (agrupa mรบltiples cambios)        โ
โ                                     โ
โ   Timer: [โโโโโโโโโโโโโโโโ] 100%    โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: 2000ms                 โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Debounce completado
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ Consultando PostgreSQL          โ
โ                                     โ
โ   Query 1: SELECT * FROM prueba     โ
โ            JOIN lista_precios_      โ
โ            has_prueba...            โ
โ            WHERE lista_precios_id=27โ
โ            โ 349 pruebas            โ
โ                                     โ
โ   Query 2: SELECT * FROM grupo_     โ
โ            prueba JOIN lista_       โ
โ            precios_has_gprueba...   โ
โ            WHERE lista_precios_id=27โ
โ            โ 164 grupos             โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: ~50-70ms               โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Total: 513 estudios obtenidos
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ Transformando a JSON            โ
โ                                     โ
โ   Estructura:                       โ
โ   {                                 โ
โ     "metadata": {...},              โ
โ     "estudios": [                   โ
โ       {                             โ
โ         "id": 1,                    โ
โ         "nombre": "Hematologรญa...", โ
โ         "precio": 10.00,            โ
โ         "tipo_item": "grupo",       โ
โ         ...                         โ
โ       },                            โ
โ       ...                           โ
โ     ]                               โ
โ   }                                 โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: ~10ms                  โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  JSON listo: ~1.2MB
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐พ Guardando JSON                  โ
โ                                     โ
โ   Destino 1:                        โ
โ   /sync-service/output/precios.json โ
โ   โ Guardado                        โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: ~5ms                   โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Auto-copy activado
      โ
      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ Copiando a proyecto web         โ
โ                                     โ
โ   Destino 2:                        โ
โ   /laboratorio-eg/public/data/      โ
โ   precios.json                      โ
โ   โ Copiado                         โ
โ                                     โ
โ   โฑ๏ธ  Tiempo: ~2ms                   โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  โ Sincronizaciรณn completada
      โ
      โผ


PASO 5: JSON DISPONIBLE PARA FRONTEND
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Archivo actualizado:              โ
โ                                     โ
โ   ๐ /laboratorio-eg/public/data/    โ
โ      precios.json                   โ
โ                                     โ
โ   Tamaรฑo: 1.2 MB                    โ
โ   Estudios: 513                     โ
โ   Timestamp: 2025-10-22 11:54:40    โ
โ                                     โ
โ   Disponible en:                    โ
โ   http://localhost:5173/data/       โ
โ   precios.json                      โ
โ                                     โ
โ   โฑ๏ธ  Tiempo total desde cambio:     โ
โ      ~2.1 segundos                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  Usuario refresca navegador
      โ  (Cmd+Shift+R)
      โ
      โผ


PASO 6: FRONTEND CARGA NUEVO JSON
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Frontend (React + Vite)           โ
โ   http://localhost:5173/estudios    โ
โ                                     โ
โ   Hook: useLabData()                โ
โ   โโ fetch('/data/precios.json')   โ
โ   โโ Parse JSON                     โ
โ   โโ Cache en localStorage          โ
โ   โโ Renderizar estudios            โ
โ                                     โ
โ   โฑ๏ธ  Tiempo de carga: ~100-200ms    โ
โโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ
      โ  UI actualizada
      โ
      โผ


PASO 7: USUARIO VE PRECIO ACTUALIZADO
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ฅ๏ธ  Pantalla del Usuario           โ
โ                                     โ
โ   Estudios > Bรบsqueda:              โ
โ   "Hematologรญa Completa"            โ
โ                                     โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ   โ Hematologรญa Completa          โ โ
โ   โ Cรณdigo: 1001                  โ โ
โ   โ Precio: $10.00 โ             โ โ
โ   โ                               โ โ
โ   โ [Ver Detalles]                โ โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                     โ
โ   โ Precio actualizado correctamenteโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Tiempos de Propagaciรณn

```
Evento                              Tiempo      Acumulado
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
UPDATE en PostgreSQL                ~1ms        1ms
TRIGGER dispara NOTIFY              ~1ms        2ms
Listeners reciben notificaciรณn      ~1ms        3ms
Backend invalida cache              ~1ms        4ms
Sync Service inicia debounce        โ           โ
  โธ๏ธ  Espera (agrupa cambios)        2000ms      2004ms
Sync consulta PostgreSQL            ~70ms       2074ms
Transforma datos a JSON             ~10ms       2084ms
Guarda JSON local                   ~5ms        2089ms
Copia a proyecto web                ~2ms        2091ms
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
TOTAL: Cambio โ JSON disponible     ~2.1 segundos

Usuario refresca navegador          ~200ms      2291ms
Frontend carga y renderiza          ~100ms      2391ms
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
TOTAL: Cambio โ Usuario ve precio   ~2.4 segundos
```

---

## Componentes Crรญticos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   COMPONENTE: Backend API                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  Archivo: server/config/pg-listener.js                          โ
โ                                                                  โ
โ  class PostgresListener {                                       โ
โ    async connect() {                                            โ
โ      this.client = new Client({...});                           โ
โ      await this.client.connect();                               โ
โ      await this.client.query('LISTEN precio_cambio');           โ
โ                                                                  โ
โ      this.client.on('notification', (msg) => {                  โ
โ        this.handleNotification(msg);                            โ
โ      });                                                         โ
โ    }                                                             โ
โ                                                                  โ
โ    handleNotification(msg) {                                    โ
โ      const payload = JSON.parse(msg.payload);                   โ
โ      this.invalidateCache(payload);                             โ
โ    }                                                             โ
โ                                                                  โ
โ    invalidateCache(payload) {                                   โ
โ      if (payload.tabla === 'lista_precios_has_prueba') {        โ
โ        cacheManager.invalidate('pruebas');                      โ
โ      }                                                           โ
โ      if (payload.tabla === 'lista_precios_has_gprueba') {       โ
โ        cacheManager.invalidate('grupos');                       โ
โ      }                                                           โ
โ    }                                                             โ
โ  }                                                               โ
โ                                                                  โ
โ  โ Estado: ACTIVO                                               โ
โ  ๐ Puerto: 3001                                                 โ
โ  ๐ก Canal: precio_cambio                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  COMPONENTE: Sync Service                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  Archivo: src/services/postgres-listener.js                     โ
โ                                                                  โ
โ  class SyncListener {                                           โ
โ    constructor() {                                              โ
โ      this.debounceTimer = null;                                 โ
โ      this.debounceMs = 2000;                                    โ
โ    }                                                             โ
โ                                                                  โ
โ    async start() {                                              โ
โ      this.client = new Client({...});                           โ
โ      await this.client.connect();                               โ
โ      await this.client.query('LISTEN precio_cambio');           โ
โ                                                                  โ
โ      this.client.on('notification', (msg) => {                  โ
โ        this.handleNotification(msg);                            โ
โ      });                                                         โ
โ    }                                                             โ
โ                                                                  โ
โ    handleNotification(msg) {                                    โ
โ      clearTimeout(this.debounceTimer);                          โ
โ                                                                  โ
โ      this.debounceTimer = setTimeout(() => {                    โ
โ        this.triggerSync();                                      โ
โ      }, this.debounceMs);                                       โ
โ    }                                                             โ
โ                                                                  โ
โ    async triggerSync() {                                        โ
โ      await sync(); // Genera JSON                               โ
โ      // Auto-copy activado en file-service.js                   โ
โ    }                                                             โ
โ  }                                                               โ
โ                                                                  โ
โ  โ Estado: ACTIVO                                               โ
โ  ๐ Puerto: 3002                                                 โ
โ  ๐ก Canal: precio_cambio                                         โ
โ  โฑ๏ธ  Debounce: 2000ms                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  COMPONENTE: PostgreSQL Trigger                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  Tablas monitoreadas:                                           โ
โ  โข lista_precios_has_prueba                                     โ
โ  โข lista_precios_has_gprueba                                    โ
โ                                                                  โ
โ  Trigger: precio_cambio_notify                                  โ
โ                                                                  โ
โ  CREATE OR REPLACE FUNCTION notify_precio_cambio()              โ
โ  RETURNS trigger AS $$                                          โ
โ  BEGIN                                                           โ
โ    PERFORM pg_notify('precio_cambio',                           โ
โ      json_build_object(                                         โ
โ        'tabla', TG_TABLE_NAME,                                  โ
โ        'operacion', TG_OP,                                      โ
โ        'timestamp', NOW(),                                      โ
โ        'registro_id', NEW.id,                                   โ
โ        'lista_precios_id', NEW.lista_precios_id                 โ
โ      )::text                                                    โ
โ    );                                                            โ
โ    RETURN NEW;                                                  โ
โ  END;                                                            โ
โ  $$ LANGUAGE plpgsql;                                           โ
โ                                                                  โ
โ  Eventos: INSERT, UPDATE, DELETE                                โ
โ                                                                  โ
โ  โ Estado: INSTALADO                                            โ
โ  ๐ก Canal: precio_cambio                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**รltima actualizaciรณn:** 22 de Octubre, 2025
