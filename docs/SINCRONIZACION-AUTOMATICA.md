# Sistema de Sincronizaci√≥n Autom√°tica de Precios

## Descripci√≥n General

Sistema completo de sincronizaci√≥n en tiempo real de precios desde la base de datos PostgreSQL (labsisEG) hacia la aplicaci√≥n web PWA. Los cambios en los precios se propagan autom√°ticamente sin intervenci√≥n manual.

**Fecha de implementaci√≥n:** 22 de Octubre, 2025
**Base de datos:** labsisEG
**Lista de precios:** ID 27 (Ambulatorio_Abril_2025)

---

## Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         LABSIS (Sistema LIS)                     ‚îÇ
‚îÇ                  Modificaci√≥n de Precios Manual                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PostgreSQL Database (labsisEG)                ‚îÇ
‚îÇ  Tablas: lista_precios_has_prueba, lista_precios_has_gprueba    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚Üì                               ‚Üì
    [TRIGGER]                      [TRIGGER]
    precio_cambio_notify           precio_cambio_notify
          ‚Üì                               ‚Üì
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚Üì
            [NOTIFY "precio_cambio"]
                      ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚Üì                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Backend API     ‚îÇ    ‚îÇ   Sync Service       ‚îÇ
‚îÇ   (port 3001)     ‚îÇ    ‚îÇ   (port 3002)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ PostgreSQL      ‚îÇ    ‚îÇ ‚Ä¢ PostgreSQL         ‚îÇ
‚îÇ   Listener        ‚îÇ    ‚îÇ   Listener           ‚îÇ
‚îÇ ‚Ä¢ Cache           ‚îÇ    ‚îÇ ‚Ä¢ Debounce (2s)      ‚îÇ
‚îÇ   Invalidation    ‚îÇ    ‚îÇ ‚Ä¢ JSON Generator     ‚îÇ
‚îÇ ‚Ä¢ REST API        ‚îÇ    ‚îÇ ‚Ä¢ Auto-copy to Web   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚Üì
                         [Copia Autom√°tica]
                                    ‚Üì
                    /laboratorio-eg/public/data/precios.json
                                    ‚Üì
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Frontend (Vite)         ‚îÇ
                    ‚îÇ   http://localhost:5173   ‚îÇ
                    ‚îÇ                           ‚îÇ
                    ‚îÇ ‚Ä¢ Lee JSON est√°tico       ‚îÇ
                    ‚îÇ ‚Ä¢ PWA con Service Worker  ‚îÇ
                    ‚îÇ ‚Ä¢ Cache del navegador     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Componentes del Sistema

### 1. Triggers de PostgreSQL

**Ubicaci√≥n:** Base de datos `labsisEG`

#### Trigger: `precio_cambio_notify`

Detecta cambios en las tablas de precios y env√≠a notificaciones al canal `precio_cambio`.

**Tablas monitoreadas:**
- `lista_precios_has_prueba` (pruebas individuales)
- `lista_precios_has_gprueba` (grupos/perfiles)

**Eventos detectados:**
- `INSERT` - Nuevos precios
- `UPDATE` - Modificaci√≥n de precios
- `DELETE` - Eliminaci√≥n de precios

**Payload de notificaci√≥n:**
```json
{
  "tabla": "lista_precios_has_prueba",
  "operacion": "UPDATE",
  "timestamp": "2025-10-22T11:36:21.478579-06:00",
  "registro_id": 1536,
  "usuario": "labsis",
  "lista_precios_id": 27
}
```

**Verificar triggers instalados:**
```sql
SELECT
  trigger_name,
  event_manipulation,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name LIKE '%precio_cambio%';
```

---

### 2. Backend API (Express + Node.js)

**Ubicaci√≥n:** `/Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/laboratorio-eg/server/`
**Puerto:** 3001
**URL:** http://localhost:3001

#### Caracter√≠sticas:

1. **PostgreSQL Listener** (`server/config/pg-listener.js`)
   - Escucha el canal `precio_cambio`
   - Invalida cache autom√°ticamente
   - Reconexi√≥n autom√°tica en caso de fallo

2. **Cache Management**
   - NodeCache en memoria
   - TTL: 600s (pruebas), 1800s (grupos)
   - Invalidaci√≥n selectiva por tipo de cambio

3. **API Endpoints**
   - `GET /api/pruebas` - Lista de pruebas con precios
   - `GET /api/grupos` - Lista de grupos con precios
   - `GET /api/grupos/:id` - Detalle de grupo con precio correcto
   - `POST /api/cache/flush` - Limpiar cache manualmente

#### Configuraci√≥n de precios correctos:

**Archivo modificado:** `server/models/index.js`

M√©todo `findByIdWithPruebas()` ahora obtiene precios desde `lista_precios_has_gprueba`:

```javascript
async findByIdWithPruebas(id, listaPreciosId = 27) {
  const groupQuery = `
    SELECT
      gp.*,
      COALESCE(lpg.precio, gp.precio) as precio_lista
    FROM grupo_prueba gp
    LEFT JOIN lista_precios_has_gprueba lpg
      ON gp.id = lpg.gprueba_id
      AND lpg.lista_precios_id = $2
    WHERE gp.id = $1 AND gp.activa = true
  `;

  const grupo = groupResult.rows[0];
  return {
    ...grupo,
    precio: grupo.precio_lista, // Usa precio de lista_precios_id=27
    pruebas: pruebasResult.rows,
    // ...
  };
}
```

#### Headers anti-cache:

```javascript
const noCacheMiddleware = (req, res, next) => {
  res.set({
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0'
  });
  next();
};
```

Aplicado a endpoints:
- `/api/pruebas`
- `/api/grupos`
- `/api/grupos/:id`

---

### 3. Sync Service (Node.js)

**Ubicaci√≥n:** `/Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/sync-service/`
**Puerto:** 3002
**URL:** http://localhost:3002

#### Caracter√≠sticas:

1. **PostgreSQL Listener** (`src/services/postgres-listener.js`)
   - Escucha canal `precio_cambio`
   - Debounce de 2 segundos (agrupa m√∫ltiples cambios)
   - Trigger autom√°tico de sincronizaci√≥n

2. **Generador de JSON** (`src/services/sync-service.js`)
   - Consulta completa a base de datos
   - 349 pruebas + 164 grupos = 513 estudios
   - Formato optimizado para frontend

3. **Auto-copy a proyecto web** (`src/storage/file-service.js`)
   - Copia autom√°tica a `/laboratorio-eg/public/data/precios.json`
   - Sin necesidad de intervenci√≥n manual
   - Verificaci√≥n de integridad

#### Configuraci√≥n (.env):

```env
# Base de datos
LABSIS_HOST=localhost
LABSIS_PORT=5432
LABSIS_DB=labsisEG
LABSIS_USER=labsis
LABSIS_PASSWORD=labsis

# Lista de precios
LISTA_PRECIOS_ID=27

# Debounce (milisegundos)
DEBOUNCE_MS=2000

# Auto-copy a proyecto web
AUTO_COPY_TO_WEB=true
WEB_PROJECT_PATH=/Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/laboratorio-eg/public/data

# Auto-copy a servidor remoto (desactivado en local)
AUTO_COPY_TO_REMOTE=false

# Servidor HTTP
HTTP_PORT=3002
```

#### Queries SQL:

**Pruebas individuales:**
```sql
SELECT
  p.id,
  p.nomenclatura as codigo,
  p.nombre,
  lpp.precio,
  -- ... m√°s campos
FROM prueba p
INNER JOIN lista_precios_has_prueba lpp
  ON p.id = lpp.prueba_id
  AND lpp.lista_precios_id = 27
WHERE p.activa = true
ORDER BY p.nombre ASC
```

**Grupos de pruebas:**
```sql
SELECT
  gp.id,
  gp.codigo_caja as codigo,
  gp.nombre,
  lpg.precio,
  -- ... m√°s campos
FROM grupo_prueba gp
INNER JOIN lista_precios_has_gprueba lpg
  ON gp.id = lpg.gprueba_id
  AND lpg.lista_precios_id = 27
WHERE gp.activa = true
ORDER BY gp.nombre ASC
```

---

### 4. Frontend (React + Vite)

**Ubicaci√≥n:** `/Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/laboratorio-eg/`
**Puerto:** 5173
**URL:** http://localhost:5173

#### Caracter√≠sticas:

1. **Hook personalizado** (`src/hooks/useLabDataDB.js`)
   - Lee JSON est√°tico desde `/data/precios.json`
   - Cache en localStorage
   - B√∫squeda en memoria (sin llamadas a API)

2. **Lectura del JSON:**
```javascript
const response = await fetch('/data/precios.json');
const jsonData = await response.json();
```

3. **Estructura del JSON:**
```json
{
  "metadata": {
    "version": "2.0.0",
    "fechaSincronizacion": "2025-10-22T17:54:40.123Z",
    "totalEstudios": 513,
    "totalPruebas": 349,
    "totalGrupos": 164,
    "listaPreciosId": 27
  },
  "estudios": [
    {
      "id": 1,
      "nombre": "Hematolog√≠a Completa",
      "tipo_item": "grupo",
      "precio": 10.00,
      "codigo": "1001",
      "categoria": null,
      "activo": true,
      "pruebas": [...]
    }
  ]
}
```

---

## Flujo Completo de Sincronizaci√≥n

### Paso a Paso:

1. **Usuario modifica precio en Labsis**
   ```sql
   UPDATE lista_precios_has_gprueba
   SET precio = 10.00
   WHERE gprueba_id = 1 AND lista_precios_id = 27;
   ```

2. **Trigger PostgreSQL dispara NOTIFY**
   ```
   NOTIFY precio_cambio, '{"tabla":"lista_precios_has_gprueba",...}'
   ```

3. **Backend API recibe notificaci√≥n**
   - PostgreSQL Listener detecta el cambio
   - Invalida cache de grupos
   - Log: `üóëÔ∏è Invalidando cach√© por cambio en "lista_precios_has_gprueba"`

4. **Sync Service recibe notificaci√≥n**
   - PostgreSQL Listener detecta el cambio
   - Log: `üîî Notificaci√≥n recibida {"canal":"precio_cambio",...}`
   - Espera 2 segundos (debounce) para agrupar cambios

5. **Sync Service regenera JSON**
   - Log: `‚è±Ô∏è Debounce completado (2000ms), iniciando sincronizaci√≥n...`
   - Consulta 349 pruebas + 164 grupos
   - Genera JSON de ~1.2MB
   - Guarda en `/sync-service/output/precios.json`

6. **Auto-copy a proyecto web**
   - Log: `üìã JSON copiado a proyecto web`
   - Copia a `/laboratorio-eg/public/data/precios.json`
   - Disponible en http://localhost:5173/data/precios.json

7. **Usuario refresca navegador**
   - Presiona Cmd+Shift+R (Mac) o Ctrl+Shift+R (Windows)
   - Frontend lee nuevo JSON
   - Muestra precios actualizados

### Tiempos de propagaci√≥n:

- Trigger ‚Üí NOTIFY: **Instant√°neo** (~1ms)
- NOTIFY ‚Üí Listeners: **Instant√°neo** (~1-5ms)
- Backend cache invalidation: **Instant√°neo** (~1ms)
- Sync Service debounce: **2 segundos** (configurable)
- Generaci√≥n de JSON: **50-100ms**
- Copia a web: **1-5ms**
- **Total: ~2.1 segundos** desde cambio hasta JSON disponible

---

## Comandos de Operaci√≥n

### Iniciar servicios:

```bash
# Backend + Frontend
cd /Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/laboratorio-eg
npm run dev:all

# Sync Service
cd /Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/sync-service
npm run dev
```

### Sincronizaci√≥n manual (si es necesario):

```bash
cd /Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/sync-service
node scripts/manual-sync.js
cp output/precios.json ../laboratorio-eg/public/data/precios.json
```

### Verificar servicios corriendo:

```bash
# Frontend
curl -I http://localhost:5173

# Backend API
curl http://localhost:3001/api/statistics

# Sync Service
curl http://localhost:3002

# PostgreSQL
psql -h localhost -U labsis -d labsisEG -c "SELECT version();"
```

### Verificar listeners activos:

```bash
# Ver procesos escuchando en PostgreSQL
psql -h localhost -U labsis -d labsisEG -c "
  SELECT pid, application_name, state, query
  FROM pg_stat_activity
  WHERE query LIKE '%LISTEN%';
"
```

### Limpiar cache manualmente:

```bash
# Backend API cache
curl -X POST http://localhost:3001/api/cache/flush

# Frontend localStorage
# En DevTools del navegador:
# localStorage.removeItem('labdata_cache');
```

---

## Monitoreo y Logs

### Backend API logs:

```
‚úÖ PostgreSQL Listener conectado y escuchando canal "precio_cambio"
üîî Notificaci√≥n recibida en canal "precio_cambio"
üì¶ Payload: {"tabla":"lista_precios_has_gprueba","operacion":"UPDATE",...}
üóëÔ∏è Invalidando cach√© por cambio en "lista_precios_has_gprueba"
Cache invalidated: 0 keys matching "grupos"
‚úÖ Cach√© de grupos invalidado
```

### Sync Service logs:

```
‚úÖ Escuchando canal 'precio_cambio' {"debounce":"2000ms"}
üîî Notificaci√≥n recibida {"canal":"precio_cambio","tabla":"lista_precios_has_gprueba"}
‚è±Ô∏è Debounce completado (2000ms), iniciando sincronizaci√≥n...
üìä Consultando base de datos labsisEG...
‚úÖ 349 pruebas y 164 grupos obtenidos
üíæ JSON guardado localmente {"path":"...","size":"1239.51 KB"}
üìã JSON copiado a proyecto web {"destination":"..."}
‚úÖ Sincronizaci√≥n completada exitosamente {"duracion":"97ms","estudios":513}
```

---

## Troubleshooting

### Problema: JSON no se actualiza autom√°ticamente

**Verificar:**
1. Sync Service est√° corriendo en puerto 3002
2. AUTO_COPY_TO_WEB=true en `.env`
3. WEB_PROJECT_PATH apunta al directorio correcto
4. Permisos de escritura en `/laboratorio-eg/public/data/`

**Soluci√≥n:**
```bash
cd /Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/sync-service
# Verificar configuraci√≥n
cat .env | grep -E "AUTO_COPY|WEB_PROJECT"

# Reiniciar sync-service
pkill -f "sync-service"
npm run dev
```

### Problema: Cache del backend no se invalida

**Verificar:**
1. Backend tiene PostgreSQL Listener activo
2. Triggers de PostgreSQL est√°n instalados
3. Canal de notificaci√≥n es correcto (`precio_cambio`)

**Soluci√≥n:**
```bash
# Verificar triggers
psql -h localhost -U labsis -d labsisEG -c "
  SELECT trigger_name, event_object_table
  FROM information_schema.triggers
  WHERE trigger_name LIKE '%precio_cambio%';
"

# Verificar listener en backend logs
# Buscar: "‚úÖ PostgreSQL Listener conectado"

# Reiniciar backend
cd /Users/samuelquiroz/Documents/proyectos/Test-Directory-EG/laboratorio-eg
pkill -f "node server/index.js"
npm run server
```

### Problema: Frontend muestra precios antiguos

**Causa:** Cache del navegador

**Soluci√≥n:**
1. Hard refresh: **Cmd+Shift+R** (Mac) o **Ctrl+Shift+R** (Windows)
2. Limpiar localStorage:
   ```javascript
   // En DevTools Console:
   localStorage.removeItem('labdata_cache');
   location.reload();
   ```
3. Desactivar cache en DevTools ‚Üí Network ‚Üí Disable cache

### Problema: Conflicto de puertos

**S√≠ntoma:** `EADDRINUSE: address already in use`

**Soluci√≥n:**
```bash
# Matar procesos en puerto espec√≠fico
lsof -ti:3001 | xargs kill -9  # Backend
lsof -ti:3002 | xargs kill -9  # Sync Service
lsof -ti:5173 | xargs kill -9  # Frontend

# Reiniciar servicios
npm run dev:all
```

---

## Testing del Sistema

### Test 1: Actualizaci√≥n de precio de grupo

```bash
# 1. Actualizar precio
psql -h localhost -U labsis -d labsisEG -c "
  UPDATE lista_precios_has_gprueba
  SET precio = 15.00
  WHERE gprueba_id = 1 AND lista_precios_id = 27;
"

# 2. Esperar 2-3 segundos (debounce)

# 3. Verificar JSON
curl -s http://localhost:5173/data/precios.json | \
  python3 -c "import sys, json; data = json.load(sys.stdin); \
  hema = [e for e in data['estudios'] if e['id'] == 1]; \
  print(f'Precio: ${hema[0][\"precio\"]}' if hema else 'No encontrado')"

# 4. Verificar API
curl -s http://localhost:3001/api/grupos/1 | \
  python3 -c "import sys, json; data = json.load(sys.stdin); \
  print(f'Precio: ${data[\"data\"][\"precio\"]}')"
```

### Test 2: Actualizaci√≥n de precio de prueba

```bash
# 1. Actualizar precio de prueba
psql -h localhost -U labsis -d labsisEG -c "
  UPDATE lista_precios_has_prueba
  SET precio = 5.00
  WHERE prueba_id = 62 AND lista_precios_id = 27;
"

# 2. Esperar 2-3 segundos

# 3. Verificar cambios (similar al Test 1)
```

### Test 3: M√∫ltiples cambios (debounce)

```bash
# 1. Hacer varios cambios r√°pidos
psql -h localhost -U labsis -d labsisEG -c "
  UPDATE lista_precios_has_gprueba SET precio = 10.00 WHERE gprueba_id = 1;
  UPDATE lista_precios_has_gprueba SET precio = 11.00 WHERE gprueba_id = 2;
  UPDATE lista_precios_has_gprueba SET precio = 12.00 WHERE gprueba_id = 3;
"

# 2. Observar logs del sync-service
# Deber√≠a ver UNA sola sincronizaci√≥n despu√©s de 2 segundos
# (agrupa los 3 cambios en una sincronizaci√≥n)
```

---

## Configuraci√≥n de Producci√≥n

### Recomendaciones:

1. **Aumentar debounce en producci√≥n:**
   ```env
   DEBOUNCE_MS=5000  # 5 segundos en producci√≥n
   ```

2. **Activar auto-copy a servidor remoto:**
   ```env
   AUTO_COPY_TO_REMOTE=true
   REMOTE_HOST=52.55.189.120
   REMOTE_USER=dynamtek
   REMOTE_KEY_PATH=/path/to/key.pem
   REMOTE_PATH=/path/to/production/data/precios.json
   ```

3. **Configurar SSL para PostgreSQL:**
   ```env
   DB_SSL=true
   ```

4. **Usar PM2 para procesos:**
   ```bash
   # Backend
   pm2 start server/index.js --name laboratorio-backend

   # Sync Service
   pm2 start sync-service/src/index.js --name laboratorio-sync
   ```

5. **Configurar Nginx para cache del JSON:**
   ```nginx
   location /data/precios.json {
       add_header Cache-Control "public, max-age=60";
       add_header Last-Modified $date_gmt;
   }
   ```

---

## Archivos Clave Modificados

### Backend API:

1. **`server/config/pg-listener.js`** (NUEVO)
   - PostgreSQL LISTEN/NOTIFY client
   - Invalidaci√≥n autom√°tica de cache

2. **`server/models/index.js`**
   - M√©todo `findByIdWithPruebas()` modificado
   - JOIN con `lista_precios_has_gprueba`
   - Usa `precio_lista` de lista_precios_id=27

3. **`server/routes/api.js`**
   - Headers anti-cache en endpoints
   - Middleware `noCacheMiddleware`

4. **`server/index.js`**
   - Inicializaci√≥n de PostgreSQL Listener
   - Graceful shutdown

### Sync Service:

1. **`.env`**
   - `AUTO_COPY_TO_WEB=true`
   - `WEB_PROJECT_PATH=/path/to/laboratorio-eg/public/data`

2. **`src/services/postgres-listener.js`**
   - LISTEN al canal `precio_cambio`
   - Debounce de 2 segundos
   - Trigger autom√°tico de sincronizaci√≥n

3. **`src/storage/file-service.js`**
   - Auto-copy a proyecto web
   - Funci√≥n `copyToWebProject()`

---

## M√©tricas del Sistema

### Performance:

- **Generaci√≥n de JSON:** 50-100ms (513 estudios)
- **Tama√±o del JSON:** ~1.2 MB
- **Debounce:** 2 segundos (configurable)
- **Propagaci√≥n total:** ~2.1 segundos (desde DB hasta JSON)

### Base de datos:

- **Pruebas activas:** 349
- **Grupos activos:** 164
- **Total estudios:** 513
- **Lista de precios:** ID 27 (Ambulatorio_Abril_2025)

### Recursos:

- **Backend API:** ~50MB RAM
- **Sync Service:** ~60MB RAM
- **Frontend (Vite):** ~40MB RAM
- **PostgreSQL connections:** 2 (backend + sync-service)

---

## Contacto y Soporte

**Proyecto:** Laboratorio EG - Sistema de Sincronizaci√≥n de Precios
**Fecha:** 22 de Octubre, 2025
**Stack:** Node.js, Express, PostgreSQL, React, Vite

**Servicios:**
- Frontend: http://localhost:5173
- Backend API: http://localhost:3001
- Sync Service: http://localhost:3002

**Base de datos:** labsisEG (PostgreSQL 14.18)

---

## Pr√≥ximos Pasos

### Mejoras sugeridas:

1. **WebSocket para frontend:**
   - Notificar cambios en tiempo real sin refresh
   - Actualizaci√≥n autom√°tica de precios en pantalla

2. **Dashboard de monitoreo:**
   - Ver sincronizaciones en tiempo real
   - Historial de cambios de precios
   - M√©tricas de performance

3. **Tests automatizados:**
   - Tests de integraci√≥n del flujo completo
   - Tests unitarios de componentes
   - Tests de carga del sistema

4. **Backup autom√°tico:**
   - Versionar JSONs generados
   - Backup antes de cada sincronizaci√≥n
   - Rollback en caso de error

5. **Alertas:**
   - Notificar si sync-service falla
   - Alertar cambios de precio >50%
   - Monitoreo de salud del sistema

---

**FIN DE LA DOCUMENTACI√ìN**
