const logger = require('../../utils/logger');

/**
 * MessageTemplateService - Plantillas de mensajes para notificaciones Telegram
 *
 * Maneja la creaciÃ³n de mensajes formateados con:
 * - Markdown formatting
 * - Botones inline
 * - Emojis y estructura visual profesional
 */
class MessageTemplateService {
  constructor() {
    this.baseUrl = process.env.FRONTEND_URL || 'http://localhost:5173';
    this.labPhone = '+58 212 762.0561';
    this.labEmail = 'info@laboratorioeg.com';
  }

  /**
   * Template: Orden Pagada
   * @param {object} data - { numero, paciente, estudios, fechaEstimada }
   * @returns {object} { message, buttons }
   */
  ordenPagada(data) {
    const { numero, paciente, estudios, fechaEstimada } = data;

    const estudiosTexto = estudios.length > 0
      ? estudios.map(e => `  â€¢ ${e.nombre}`).join('\n')
      : '  â€¢ InformaciÃ³n no disponible';

    const message = `ğŸ‰ *Â¡Orden de Trabajo Registrada!*

Estimado(a) *${paciente}*,

Su orden de trabajo *#${numero}* ha sido registrada exitosamente y estÃ¡ siendo procesada.

ğŸ“‹ *Estudios solicitados:*
${estudiosTexto}

ğŸ“… *Fecha estimada de resultados:*
${fechaEstimada}

Le notificaremos automÃ¡ticamente cuando sus resultados estÃ©n listos para consultar.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'ğŸ“± Contactar Laboratorio', url: `tel:${this.labPhone.replace(/\s/g, '')}` },
      ],
      [
        { text: 'ğŸŒ Portal Web', url: this.baseUrl },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: Resultados Listos
   * @param {object} data - { numero, paciente, resultsUrl, expiresAt }
   * @returns {object} { message, buttons }
   */
  resultadosListos(data) {
    const { numero, paciente, resultsUrl, expiresAt } = data;

    const expirationDate = new Date(expiresAt);
    const diasExpiracion = Math.floor((expirationDate - new Date()) / (1000 * 60 * 60 * 24));

    const message = `âœ… *Â¡Resultados Disponibles!*

Estimado(a) *${paciente}*,

Sus resultados de la orden *#${numero}* ya estÃ¡n listos y disponibles para consultar.

â° *Acceso directo vÃ¡lido por ${diasExpiracion} dÃ­as*

Puede ver sus resultados haciendo clic en el botÃ³n de abajo, o ingresando al portal web con su cÃ©dula.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'ğŸ“„ Ver Mis Resultados', url: resultsUrl },
      ],
      [
        { text: 'ğŸ“± Contactar Laboratorio', url: `tel:${this.labPhone.replace(/\s/g, '')}` },
        { text: 'ğŸŒ Portal Web', url: this.baseUrl },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: Orden en Proceso
   * @param {object} data - { numero, paciente, estudios, etapaActual }
   * @returns {object} { message, buttons }
   */
  ordenEnProceso(data) {
    const { numero, paciente, estudios, etapaActual } = data;

    const estudiosTexto = estudios.length > 0
      ? estudios.map(e => `  â€¢ ${e.nombre}`).join('\n')
      : '  â€¢ InformaciÃ³n no disponible';

    const etapas = {
      'recepcion': 'ğŸ“¥ RecepciÃ³n de muestras',
      'analisis': 'ğŸ”¬ AnÃ¡lisis en laboratorio',
      'validacion': 'âœ“ ValidaciÃ³n de resultados',
      'listo': 'âœ… Resultados listos'
    };

    const etapaTexto = etapas[etapaActual] || 'â³ En proceso';

    const message = `â³ *Orden en Proceso*

Estimado(a) *${paciente}*,

Su orden *#${numero}* estÃ¡ siendo procesada actualmente.

ğŸ“‹ *Estudios:*
${estudiosTexto}

ğŸ“ *Etapa actual:*
${etapaTexto}

Le notificaremos cuando sus resultados estÃ©n listos.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'ğŸ“± Contactar Laboratorio', url: `tel:${this.labPhone.replace(/\s/g, '')}` },
      ],
      [
        { text: 'ğŸŒ Portal Web', url: this.baseUrl },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: Resultados CrÃ­ticos (Urgente)
   * @param {object} data - { numero, paciente, estudiosUrgentes, resultsUrl }
   * @returns {object} { message, buttons }
   */
  resultadosCriticos(data) {
    const { numero, paciente, estudiosUrgentes, resultsUrl } = data;

    const estudiosTexto = estudiosUrgentes.length > 0
      ? estudiosUrgentes.map(e => `  â€¢ ${e.nombre}`).join('\n')
      : '  â€¢ InformaciÃ³n no disponible';

    const message = `ğŸš¨ *RESULTADOS URGENTES - ATENCIÃ“N REQUERIDA*

Estimado(a) *${paciente}*,

Los resultados de su orden *#${numero}* contienen valores que requieren atenciÃ³n mÃ©dica inmediata.

âš ï¸ *Estudios con valores crÃ­ticos:*
${estudiosTexto}

*IMPORTANTE:* Por favor, consulte estos resultados con su mÃ©dico tratante a la brevedad posible.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'ğŸ“„ Ver Resultados URGENTE', url: resultsUrl },
      ],
      [
        { text: 'ğŸ“± Llamar al Laboratorio AHORA', url: `tel:${this.labPhone.replace(/\s/g, '')}` },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: Recordatorio de Retiro
   * @param {object} data - { numero, paciente, diasDisponible, direccion }
   * @returns {object} { message, buttons }
   */
  recordatorioRetiro(data) {
    const { numero, paciente, diasDisponible, direccion } = data;

    const message = `ğŸ“‹ *Recordatorio: Retiro de Resultados*

Estimado(a) *${paciente}*,

Le recordamos que los resultados fÃ­sicos de su orden *#${numero}* estÃ¡n disponibles para retiro en nuestras instalaciones.

ğŸ“ *DirecciÃ³n:*
${direccion || 'Av. Principal, Torre EG, Piso 3'}

â° *Horario de atenciÃ³n:*
Lunes a Viernes: 7:00 AM - 5:00 PM
SÃ¡bados: 8:00 AM - 12:00 PM

ğŸ“… *Disponible por:* ${diasDisponible} dÃ­as mÃ¡s

TambiÃ©n puede consultar sus resultados en lÃ­nea desde nuestro portal web.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'ğŸ—ºï¸ CÃ³mo Llegar', url: 'https://maps.google.com/?q=Laboratorio+EG' },
      ],
      [
        { text: 'ğŸ“± Contactar Laboratorio', url: `tel:${this.labPhone.replace(/\s/g, '')}` },
        { text: 'ğŸŒ Ver en Web', url: this.baseUrl },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: Bienvenida al paciente autenticado
   * @param {object} data - { paciente }
   * @returns {object} { message, buttons }
   */
  bienvenidaAutenticado(data) {
    const { paciente } = data;

    const message = `ğŸ‘‹ *Â¡Bienvenido(a), ${paciente}!*

Gracias por autenticarte con Laboratorio EG.

Ahora recibirÃ¡s notificaciones automÃ¡ticas sobre:
âœ“ Estado de tus Ã³rdenes
âœ“ Resultados listos para consultar
âœ“ Recordatorios importantes

Puedes gestionar tus preferencias de notificaciones desde nuestro portal web.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_
ğŸ“ ${this.labPhone}`;

    const buttons = [
      [
        { text: 'âš™ï¸ Configurar Notificaciones', url: `${this.baseUrl}/perfil/notificaciones` },
      ],
      [
        { text: 'ğŸŒ Ir al Portal', url: this.baseUrl },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Template: ConfirmaciÃ³n de preferencias actualizadas
   * @param {object} data - { paciente, preferencias }
   * @returns {object} { message, buttons }
   */
  preferenciasActualizadas(data) {
    const { paciente, preferencias } = data;

    const estados = {
      orden_pagada: preferencias.orden_pagada ? 'âœ…' : 'âŒ',
      resultados_listos: preferencias.resultados_listos ? 'âœ…' : 'âŒ',
      orden_en_proceso: preferencias.orden_en_proceso ? 'âœ…' : 'âŒ',
      recordatorio_retiro: preferencias.recordatorio_retiro ? 'âœ…' : 'âŒ',
      resultados_criticos: 'âœ… (Siempre activo por seguridad)'
    };

    const message = `âš™ï¸ *Preferencias de Notificaciones Actualizadas*

Estimado(a) *${paciente}*,

Sus preferencias de notificaciones han sido actualizadas:

${estados.orden_pagada} Orden pagada
${estados.resultados_listos} Resultados listos
${estados.orden_en_proceso} Orden en proceso
${estados.recordatorio_retiro} Recordatorio de retiro
${estados.resultados_criticos}

Puede modificarlas en cualquier momento desde el portal web.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Laboratorio EG - Desde 1982_`;

    const buttons = [
      [
        { text: 'âš™ï¸ Modificar Preferencias', url: `${this.baseUrl}/perfil/notificaciones` },
      ]
    ];

    return { message, buttons };
  }

  /**
   * Formatear mensaje para envÃ­o
   * @param {string} templateName - Nombre del template
   * @param {object} data - Datos para el template
   * @returns {object} { message, buttons } o null si el template no existe
   */
  format(templateName, data) {
    const templates = {
      orden_pagada: this.ordenPagada.bind(this),
      resultados_listos: this.resultadosListos.bind(this),
      orden_en_proceso: this.ordenEnProceso.bind(this),
      resultados_criticos: this.resultadosCriticos.bind(this),
      recordatorio_retiro: this.recordatorioRetiro.bind(this),
      bienvenida_autenticado: this.bienvenidaAutenticado.bind(this),
      preferencias_actualizadas: this.preferenciasActualizadas.bind(this),
    };

    if (!templates[templateName]) {
      logger.warn(`Template no encontrado: ${templateName}`);
      return null;
    }

    return templates[templateName](data);
  }
}

// Exportar singleton
module.exports = new MessageTemplateService();
